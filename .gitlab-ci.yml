image: node:14.16.0-alpine3.11

variables:
    CI: "use"
    TAG: registry.gmdp.io/glonassmobile/toesim/web

default:
  before_script:
    - mkdir -p ~/.docker/
    - cat $docker_config > ~/.docker/config.json
    - cat $npmrc > ~/.npmrc

cache:
  paths:
    - node_modules/

stages:
    - build
    - publish
    - deploy

build:
    stage: build
    script:
        - yarn
    artifacts:
        when: always
        paths:
            - build

publish_master:
    only:
        - master
    stage: publish
    image: docker:19.03.0
    dependencies:
        - build
    script:
        - cd build
        - export DOCKER_TAG=$TAG:latest
        - docker build -t $DOCKER_TAG .
        - docker push $DOCKER_TAG

publish_release:
    only:
        - tags
    rules: 
        - if: '$CI_COMMIT_TAG =~ /^v\d+.\d+.\d+/'
    stage: publish
    image: docker:19.03.0
    dependencies:
        - build
    script:
        - version="${CI_BUILD_REF_NAME/release\//}"    
        - cd build
        - export DOCKER_TAG=$TAG:$version
        - docker build -t $DOCKER_TAG .
        - docker push $DOCKER_TAG

deploy_master:
    image: registry.gmdp.io/glonassmobile/devops/builder:1.7.0
    stage: deploy
    only:
        - master
    dependencies:
        - publish_master
    script:
        - export KUBECONFIG=$kube_config_cluster_yml
        - helm upgrade -i app
            --set reload=$(date -u +%Y-%m-%d_%H:%M:%S)
            --set version=$atest
            --set dns=toesim-dev.stand.gmdp.io
            -n toesim-web-dev
            ./src/helm

deploy_release:
    image: registry.gmdp.io/glonassmobile/devops/builder:1.7.0
    stage: deploy
    only:
        - release/*
    dependencies:
        - publish_release
    script:
        - version="${CI_BUILD_REF_NAME/release\//}"    
        - export KUBECONFIG=$kube_config_cluster_yml
        - helm upgrade -i app
            --set reload=$(date -u +%Y-%m-%d_%H:%M:%S)
            --set version=$version
            --set dns=toesim-test.stand.gmdp.io
            -n toesim-web-test
            ./src/helm            